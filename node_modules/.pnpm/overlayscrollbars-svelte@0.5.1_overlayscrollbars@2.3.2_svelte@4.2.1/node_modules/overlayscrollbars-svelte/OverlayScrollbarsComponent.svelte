<script>import { onMount, afterUpdate, createEventDispatcher, onDestroy } from 'svelte';
import { OverlayScrollbars } from 'overlayscrollbars';
import { createDefer } from './createDefer';
export let element = 'div';
export let options = undefined;
export let events = undefined;
export let defer = undefined;
let instance = null;
let elementRef = null;
let slotRef = null;
let hydrated = false;
let combinedEvents = undefined;
let prevElement;
const [requestDefer, cancelDefer] = createDefer();
const initialize = () => {
    if (!hydrated) {
        return;
    }
    const init = () => {
        instance?.destroy();
        instance = OverlayScrollbars({
            target: elementRef,
            elements: {
                viewport: slotRef,
                content: slotRef,
            },
        }, options || {}, combinedEvents || {});
    };
    if (defer) {
        requestDefer(init, defer);
    }
    else {
        init();
    }
    prevElement = element;
};
const dispatchEvents = {
    initialized: 'osInitialized',
    updated: 'osUpdated',
    destroyed: 'osDestroyed',
    scroll: 'osScroll',
};
const dispatchEvent = createEventDispatcher();
export const osInstance = () => instance;
export const getElement = () => elementRef;
onMount(() => {
    hydrated = true;
});
onDestroy(() => {
    cancelDefer();
    instance?.destroy();
});
afterUpdate(() => {
    if (prevElement !== element) {
        initialize();
    }
});
$: {
    const currEvents = events || {};
    combinedEvents = Object.keys(dispatchEvents).reduce((obj, name) => {
        const eventListener = currEvents[name];
        obj[name] = [
            (...args) => dispatchEvent(
            // @ts-ignore
            dispatchEvents[name], 
            // @ts-ignore
            args),
            ...(Array.isArray(eventListener) ? eventListener : [eventListener]).filter(Boolean),
        ];
        return obj;
    }, {});
}
$: {
    if (OverlayScrollbars.valid(instance)) {
        instance.options(options || {}, true);
    }
}
$: {
    if (OverlayScrollbars.valid(instance)) {
        instance.on(
        /* c8 ignore next */
        combinedEvents || {}, true);
    }
}
</script>

<svelte:element
  this={element}
  data-overlayscrollbars-initialize=""
  bind:this={elementRef}
  {...$$restProps}
>
  {#if hydrated}
    <div bind:this={slotRef} data-overlayscrollbars-contents>
      <slot />
    </div>
  {:else}
    <slot />
  {/if}
</svelte:element>
